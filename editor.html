<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание статьи - Орден Вики</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- СТИЛИ СТАТЬИ (КАК В ОБРАЗЦЕ) --- */
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        body { margin: 0; padding: 0; background-color: #f6f6f6; color: #202122; line-height: 1.6; }
        
        /* Стили ссылок и заголовков */
        a { color: #3366cc; text-decoration: none; cursor: pointer; }
        .header { background-color: #f8f9fa; border-bottom: 1px solid #a2a9b1; padding: 0.5em 1em; display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .logo-container { display: flex; align-items: center; }
        .logo { width: 40px; height: 40px; margin-right: 10px; }
        .logo img { width: 100%; height: 100%; object-fit: contain; }
        .logo-text { font-size: 1.25rem; font-weight: bold; line-height: 1.2; }
        .logo-text span { display: block; font-size: 0.75rem; font-weight: normal; }
        
        .container { display: flex; max-width: 1600px; margin: 0 auto; padding: 1em; }
        .main-content { flex: 1; background-color: white; border: 1px solid #a2a9b1; padding: 1.5em 2.5em; max-width: 100%; min-height: 80vh; position: relative; }
        
        .article-header { border-bottom: 1px solid #a2a9b1; padding-bottom: 0.5em; margin-bottom: 1.5em; }
        h1 { font-size: 1.875rem; font-weight: bold; margin: 0; padding: 0; line-height: 1.3; }
        
        /* Стили компонентов статьи */
        .content-box { background-color: #f8f9fa; border: 1px solid #a2a9b1; padding: 1em; margin: 1em 0; float: right; width: 320px; margin-left: 1.5em; font-size: 0.875rem; clear: right; position: relative; }
        .content-box h2 { font-size: 1rem; text-align: center; border-bottom: 1px solid #a2a9b1; margin-bottom: 0.5em; }
        
        .info-row { display: flex; margin-bottom: 0.3em; position: relative; }
        .info-label { font-weight: bold; width: 40%; }
        .info-value { width: 60%; }
        
        .info-image img, .section-image img { width: 100%; height: auto; display: block; cursor: pointer; transition: opacity 0.2s; }
        .info-image img:hover, .section-image img:hover { opacity: 0.8; outline: 2px solid #3366cc; }
        
        .note { font-size: 0.8rem; font-style: italic; color: #54595d; margin: 0.5em 0; padding: 0.5em; background-color: #f8f9fa; border-left: 3px solid #a2a9b1; }
        
        h2 { font-size: 1.5rem; font-weight: normal; border-bottom: 1px solid #a2a9b1; padding-bottom: 0.3em; margin-top: 1.5em; }
        h3 { font-size: 1.2rem; font-weight: bold; margin-top: 1.2em; }
        
        .section-image { position: relative; display: block; } /* Добавлено position relative для кнопки удаления */
        
        /* Стиль для списка персонажей */
.character-list {
    list-style-type: none;
    padding-left: 1.5em;
}

.character-list li {
    margin-bottom: 1em;
    padding-left: 0.5em;
    border-left: 3px solid #a2a9b1;
}

.character-name {
    font-weight: bold;
    color: #202122;
}

        /* --- СТИЛИ ИНТЕРФЕЙСА РЕДАКТОРА (НЕ ПОПАДУТ В СОХРАНЕНИЕ) --- */
        /* Убедитесь, что родительские элементы имеют position: relative */
.content-box, .section-image, .note, .character-list-container {
    position: relative !important;
}

/* Кнопка удаления блока */
.editor-block-delete {
    display: none;
    position: absolute; top: 0; right: 0;
    background: #ff4444; color: white;
    width: 30px; height: 30px;
    justify-content: center; align-items: center;
    cursor: pointer; z-index: 10;
    border-bottom-left-radius: 5px;
    box-shadow: -2px 2px 5px rgba(0,0,0,0.2);
}

/* Показывать кнопку при наведении на любой из этих блоков */
.content-box:hover .editor-block-delete,
.section-image:hover .editor-block-delete,
.note:hover .editor-block-delete,
.character-list-container:hover .editor-block-delete {
    display: flex;
}

.editor-block-delete:hover {
    background: #cc0000;
}
        
        /* Кнопки управления внутри статьи */
        .editor-btn-add-row {
            display: block; width: 100%; padding: 5px; margin-top: 10px;
            background: #e1e1e1; border: 1px dashed #999; cursor: pointer;
            text-align: center; font-size: 0.8rem; color: #555;
        }
        .editor-btn-add-row:hover { background: #d4d4d4; }
        
        /* Кнопка удаления строки в инфобоксе (маленький крестик) */
        .editor-btn-delete-row {
            display: none; position: absolute; right: -20px; top: 0;
            color: red; cursor: pointer; font-weight: bold; padding: 0 5px;
        }
        .info-row:hover .editor-btn-delete-row { display: block; }

        /* Кнопка глобального удаления блока (Инфобокс/Картинка) */
        .editor-block-delete {
            display: none;
            position: absolute; top: 0; right: 0;
            background: #ff4444; color: white;
            width: 30px; height: 30px;
            justify-content: center; align-items: center;
            cursor: pointer; z-index: 10;
            border-bottom-left-radius: 5px;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.2);
        }
        .content-box:hover .editor-block-delete,
        .section-image:hover .editor-block-delete {
            display: flex;
        }
        .editor-block-delete:hover { background: #cc0000; }

        /* Тулбар */
        #editor-toolbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            background: #2a2a2a; color: white; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .tools-group { display: flex; gap: 5px; align-items: center; }
        .tool-btn {
            background: #444; border: 1px solid #555; color: white;
            width: 36px; height: 36px; border-radius: 4px; cursor: pointer;
            font-size: 1rem; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: #666; }
        .save-group { display: flex; gap: 5px; align-items: center; }
        #filename-input { background: #fff; border: none; padding: 5px 8px; border-radius: 3px; width: 150px; height: 30px; }
        #save-btn { background: #3366cc; border: none; color: white; padding: 0 15px; height: 30px; border-radius: 3px; cursor: pointer; font-weight: bold; }

        /* Область редактирования */
        #editor-content { outline: none; min-height: 500px; padding-bottom: 100px; }
        #article-title { border: 1px dashed #ccc; padding: 5px; min-height: 1.3em; }
        #article-title:empty:before { content: "Название статьи..."; color: #aaa; font-size: 0.8em; }

        /* Плавающее меню */
        #floating-menu {
            position: absolute; background: #222; padding: 4px; border-radius: 5px;
            display: none; gap: 4px; z-index: 2000;
        }
        #floating-menu button {
            background: transparent; border: 1px solid transparent; color: white;
            padding: 4px 8px; cursor: pointer; border-radius: 3px; font-weight: bold;
        }
        #floating-menu button:hover { background: #444; border-color: #555; }

        /* Модалка */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 5px; width: 400px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; }
        .modal-buttons { text-align: right; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="editor-toolbar">
        <div class="tools-group">
            <button class="tool-btn" title="Примечание" onmousedown="event.preventDefault(); insertNote()"><i class="fas fa-sticky-note"></i></button>
            <button class="tool-btn" title="Инфобокс" onmousedown="event.preventDefault(); insertInfobox()"><i class="fas fa-info-circle"></i></button>
            <button class="tool-btn" title="Список (Таблица)" onmousedown="event.preventDefault(); insertList()"><i class="fas fa-list"></i></button>
            <button class="tool-btn" title="Изображение" onmousedown="event.preventDefault(); openImageModal()"><i class="fas fa-image"></i></button>
        </div>
        
        <div class="save-group">
            <input type="text" id="filename-input" placeholder="filename.html">
            
            <button id="save-btn" onclick="saveArticle()"><i class="fa-solid fa-floppy-disk"></i></button>
        </div>
    </div>

    <div style="height: 100px; width: 100%; clear: both;"></div>

    <div class="container">
        <main class="main-content">
            <header class="header" style="margin: -1.5em -2.5em 1.5em -2.5em;">
                <div class="logo-container">
                    <div class="logo"><img src="images/logo.png" alt="Лого" onerror="this.src='https://via.placeholder.com/40'"></div>
                    <div class="logo-text">Орден Вики <span>Энциклопедия Ананаса</span></div>
                </div>
            </header>

            <header class="article-header">
                <h1 id="article-title" contenteditable="true"></h1>
            </header>
            
            <div id="editor-content" contenteditable="true"></div>

            <div class="references">
                <h2>См. также</h2>
                <ul id="see-also-list" contenteditable="true">
                    <li><a href="#">Пример ссылки</a></li>
                </ul>
            </div>
        </main>
    </div>

    <div id="floating-menu">
        <button onmousedown="event.preventDefault(); formatText('h2')">H2</button>
        <button onmousedown="event.preventDefault(); formatText('h3')">H3</button>
        <button onmousedown="event.preventDefault(); formatText('bold')"><i class="fas fa-bold"></i></button>
        <button onmousedown="event.preventDefault(); formatText('italic')"><i class="fas fa-italic"></i></button>
        <button onmousedown="event.preventDefault(); addLink()"><i class="fas fa-link"></i></button>
        <button onmousedown="event.preventDefault(); formatText('p')">¶</button>
    </div>

    <div id="image-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0">Вставка изображения</h3>
            <div class="form-group">
                <label>Тип:</label>
                <select id="img-type">
                    <option value="normal">Обычное изображение</option>
                    <option value="flag">Флаг (маленький)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Источник:</label>
                <select id="img-source" onchange="toggleUploadInputs()">
                    <option value="upload">Загрузить с ПК</option>
                    <option value="existing">Имя файла (images/...)</option>
                </select>
            </div>
            
            <div class="form-group" id="input-upload">
                <label>Файл:</label>
                <input type="file" id="img-file-input" accept="image/*">
            </div>
            
            <div class="form-group" id="input-existing" style="display:none;">
                <label>Имя файла (напр. uwu.png):</label>
                <input type="text" id="img-name-input">
            </div>

            <div class="form-group">
                <label>Подпись (Alt):</label>
                <input type="text" id="img-alt-input">
            </div>

            <div class="modal-buttons">
                <button onclick="closeImageModal()" style="background:#ddd; border:none;">Отмена</button>
                <button onclick="confirmInsertImage()" style="background:#3366cc; color:white; border:none;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let lastRange = null; 
        let currentEditingImage = null; 
        const editorContent = document.getElementById('editor-content');
        const floatingMenu = document.getElementById('floating-menu');

        window.onbeforeunload = function() { return "Данные не сохранены."; };

        // --- УПРАВЛЕНИЕ КУРСОРОМ И МЕНЮ ---
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                if (editorContent.contains(range.commonAncestorContainer)) {
                    lastRange = range.cloneRange();
                    if (!selection.isCollapsed) {
                        const rect = range.getBoundingClientRect();
                        if (rect.top > 0) {
                            floatingMenu.style.display = 'flex';
                            floatingMenu.style.top = `${window.scrollY + rect.top - 45}px`;
                            floatingMenu.style.left = `${rect.left}px`;
                        }
                    } else {
                        floatingMenu.style.display = 'none';
                    }
                }
            }
        });
        
        // Клик по картинке для редактирования (только если кликнули не на кнопку удаления)
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG' && editorContent.contains(e.target)) {
                // Если родитель не флаг
                if (!e.target.closest('.flag-container')) {
                     openImageModal(e.target);
                }
            }
        });

        function restoreSelection() {
            editorContent.focus();
            const selection = window.getSelection();
            if (lastRange) {
                selection.removeAllRanges();
                selection.addRange(lastRange);
            } else {
                const range = document.createRange();
                range.selectNodeContents(editorContent);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
                lastRange = range;
            }
        }

        function insertHTMLAtCursor(html) {
            restoreSelection();
            document.execCommand('insertHTML', false, html);
        }

        // --- ВСТАВКА КОМПОНЕНТОВ ---

        function insertNote() {
    insertHTMLAtCursor(`<div class="note">
        <div class="editor-block-delete" contenteditable="false" onclick="this.parentElement.remove()" title="Удалить примечание"><i class="fas fa-trash"></i></div>
        <strong>Примечание:</strong> Текст примечания.
    </div><p><br></p>`);
}

function insertList() {
    insertHTMLAtCursor(`
    <div style="position: relative; margin: 1em 0;">
        <div class="editor-block-delete" contenteditable="false" onclick="this.parentElement.remove()" title="Удалить список" style="top: -15px; right: -15px;"><i class="fas fa-trash"></i></div>
        <ul class="character-list" style="list-style-type: none; padding-left: 1.5em;">
            <li style="margin-bottom: 1em; padding-left: 0.5em; border-left: 3px solid #a2a9b1;">
                <div class="character-name" style="font-weight: bold; color: #202122;">Имя персонажа 1</div>
                <p style="margin: 0.5em 0 0 0;">Описание персонажа или пункта списка.</p>
            </li>
            <li style="margin-bottom: 1em; padding-left: 0.5em; border-left: 3px solid #a2a9b1;">
                <div class="character-name" style="font-weight: bold; color: #202122;">Имя персонажа 2</div>
                <p style="margin: 0.5em 0 0 0;">Описание персонажа или пункта списка.</p>
            </li>
            <li style="margin-bottom: 1em; padding-left: 0.5em; border-left: 3px solid #a2a9b1;">
                <div class="character-name" style="font-weight: bold; color: #202122;">Имя персонажа 3</div>
                <p style="margin: 0.5em 0 0 0;">Описание персонажа или пункта списка.</p>
            </li>
        </ul>
    </div><p><br></p>`);
}

        function insertInfobox() {
            // Добавлена кнопка удаления блока (editor-block-delete)
            const html = `
            <div class="content-box">
                <div class="editor-block-delete" contenteditable="false" onclick="this.parentElement.remove()" title="Удалить инфобокс"><i class="fas fa-trash"></i></div>
                <h2 contenteditable="true">Заголовок</h2>
                <div class="info-image">
                    <img src="https://via.placeholder.com/300x200" alt="Нажмите чтобы сменить фото">
                </div>
                <div class="info-row">
                    <div class="info-label" contenteditable="true">Дата:</div>
                    <div class="info-value" contenteditable="true">...</div>
                    <span class="editor-btn-delete-row" contenteditable="false" onclick="this.parentElement.remove()">x</span>
                </div>
                <div class="info-row">
                    <div class="info-label" contenteditable="true">Место:</div>
                    <div class="info-value" contenteditable="true">...</div>
                    <span class="editor-btn-delete-row" contenteditable="false" onclick="this.parentElement.remove()">x</span>
                </div>
                <button class="editor-btn-add-row" contenteditable="false" onclick="addInfoboxRow(this)">[+] Добавить строку</button>
            </div>
            <p><br></p>`;
            insertHTMLAtCursor(html);
        }

        window.addInfoboxRow = function(btn) {
            const newRow = document.createElement('div');
            newRow.className = 'info-row';
            newRow.innerHTML = `
                <div class="info-label" contenteditable="true">Поле:</div>
                <div class="info-value" contenteditable="true">Значение</div>
                <span class="editor-btn-delete-row" contenteditable="false" onclick="this.parentElement.remove()">x</span>
            `;
            btn.parentNode.insertBefore(newRow, btn);
        }

        

        // --- КАРТИНКИ ---
        
        function openImageModal(existingImgElement = null) {
            const modal = document.getElementById('image-modal');
            const title = document.getElementById('modal-title');
            
            if (existingImgElement) {
                currentEditingImage = existingImgElement;
                title.innerText = "Изменить изображение";
                document.getElementById('img-alt-input').value = existingImgElement.alt;
            } else {
                if (!lastRange && window.getSelection().rangeCount > 0) {
                   lastRange = window.getSelection().getRangeAt(0).cloneRange();
                }
                currentEditingImage = null;
                title.innerText = "Вставить новое изображение";
                document.getElementById('img-alt-input').value = "";
            }
            modal.style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = 'none';
            if (!currentEditingImage) restoreSelection();
        }

        function toggleUploadInputs() {
            const type = document.getElementById('img-source').value;
            document.getElementById('input-upload').style.display = type === 'upload' ? 'block' : 'none';
            document.getElementById('input-existing').style.display = type === 'existing' ? 'block' : 'none';
        }

        function confirmInsertImage() {
            const type = document.getElementById('img-type').value;
            const source = document.getElementById('img-source').value;
            const alt = document.getElementById('img-alt-input').value;

            const applyImage = (src) => {
                if (currentEditingImage) {
                    currentEditingImage.src = src;
                    currentEditingImage.alt = alt;
                } else {
                    let html = '';
                    if (type === 'flag') {
                        html = `<span class="flag-container" style="display:inline-block; height:20px; vertical-align:middle; margin-right:5px;"><img src="${src}" alt="${alt}" class="flag" style="height:20px; width:auto;"></span> `;
                    } else {
                        // Добавлена кнопка удаления для картинки
                        html = `<div class="section-image" style="max-width:400px; margin:1em 0;">
                                    <div class="editor-block-delete" contenteditable="false" onclick="this.parentElement.remove()" title="Удалить фото"><i class="fas fa-trash"></i></div>
                                    <img src="${src}" alt="${alt}" style="width:100%;">
                                </div><p><br></p>`;
                    }
                    restoreSelection();
                    document.execCommand('insertHTML', false, html);
                }
                closeImageModal();
            };

            if (source === 'upload') {
                const fileInput = document.getElementById('img-file-input');
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => applyImage(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    alert("Выберите файл!");
                }
            } else {
                const name = document.getElementById('img-name-input').value;
                if(name) applyImage('images/' + name);
                else alert("Введите имя файла!");
            }
        }

        function formatText(cmd) {
            if (cmd === 'h2' || cmd === 'h3' || cmd === 'p') {
                document.execCommand('formatBlock', false, '<' + cmd + '>');
            } else {
                document.execCommand(cmd, false, null);
            }
        }
        
        function addLink() {
            const url = prompt("URL:", "http://");
            if(url) document.execCommand('createLink', false, url);
        }

        // --- СОХРАНЕНИЕ ---
        function saveArticle() {
            const filename = document.getElementById('filename-input').value;
            const title = document.getElementById('article-title').innerText;
            
            const contentClone = editorContent.cloneNode(true);
            const seeAlsoClone = document.getElementById('see-also-list').cloneNode(true);

            // ОЧИСТКА: Удаляем все кнопки редактора (включая новые кнопки удаления блоков)
            const buttons = contentClone.querySelectorAll('.editor-btn-add-row, .editor-btn-delete-row, .editor-block-delete');
            buttons.forEach(b => b.remove());

            const editables = contentClone.querySelectorAll('[contenteditable]');
            editables.forEach(el => el.removeAttribute('contenteditable'));

            const contentHtml = contentClone.innerHTML;
            const seeAlsoHtml = seeAlsoClone.innerHTML;

            if (!filename || !/^[a-zA-Z0-9_-]+$/.test(filename)) {
                alert("Ошибка: Имя файла только латиницей!");
                return;
            }

            const fullHTML = `<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${title} - Орден Вики</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><style>
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
body { margin: 0; padding: 0; background-color: #f6f6f6; color: #202122; line-height: 1.6; }
a { color: #3366cc; text-decoration: none; } a:hover { text-decoration: underline; }
.header { background-color: #f8f9fa; border-bottom: 1px solid #a2a9b1; padding: 0.5em 1em; display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
.logo-container { display: flex; align-items: center; cursor: pointer; }
.logo { width: 40px; height: 40px; margin-right: 10px; } .logo img { width: 100%; height: 100%; object-fit: contain; }
.logo-text { font-size: 1.25rem; font-weight: bold; line-height: 1.2; } .logo-text span { display: block; font-size: 0.75rem; font-weight: normal; }
.container { display: flex; max-width: 1600px; margin: 0 auto; padding: 1em; }
.main-content { flex: 1; background-color: white; border: 1px solid #a2a9b1; padding: 1.5em 2.5em; max-width: 100%; }
.article-header { border-bottom: 1px solid #a2a9b1; padding-bottom: 0.5em; margin-bottom: 1.5em; }
.article-header h1 { font-size: 1.875rem; font-weight: bold; margin: 0; padding: 0; line-height: 1.3; }
.content-box { background-color: #f8f9fa; border: 1px solid #a2a9b1; padding: 1em; margin: 1em 0; float: right; width: 320px; margin-left: 1.5em; font-size: 0.875rem; }
.content-box h2 { font-size: 1rem; font-weight: bold; text-align: center; margin: 0 0 0.5em 0; padding-bottom: 0.3em; border-bottom: 1px solid #a2a9b1; }
.info-image { width: 100%; margin-bottom: 0.5em; } .info-image img { width: 100%; height: auto; display: block; }
.info-row { display: flex; margin-bottom: 0.3em; } .info-label { font-weight: bold; width: 40%; } .info-value { width: 60%; }
.info-table { width: 100%; margin: 0.5em 0; border-collapse: collapse; }
.info-table .center-text { text-align: center; font-weight: bold; padding: 0.3em 0; border-bottom: 1px solid #d0d0d0; }
.info-table .side { width: 50%; vertical-align: top; padding: 0.3em; }
.info-table .flag-container { display: inline-block; vertical-align: middle; margin-right: 5px; height: 20px; overflow: hidden; }
.info-table .flag { height: 20px; width: auto; display: block; }
p { margin: 0.5em 0 1em 0; }
h2 { font-size: 1.5rem; font-weight: normal; border-bottom: 1px solid #a2a9b1; padding-bottom: 0.3em; margin-top: 1.5em; margin-bottom: 0.7em; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
h2 .toggle-icon { font-size: 1rem; color: #54595d; margin-left: 10px; }
.collapsible-content { overflow: hidden; transition: max-height 0.3s ease-out; } .collapsed { max-height: 0 !important; }
h3 { font-size: 1.2rem; font-weight: bold; margin-top: 1.2em; margin-bottom: 0.5em; }
.section-image { width: 100%; max-width: 400px; margin: 1em 0; } .section-image img { width: 100%; height: auto; display: block; }
.note { font-size: 0.8rem; font-style: italic; color: #54595d; margin: 0.5em 0; padding: 0.5em; background-color: #f8f9fa; border-left: 3px solid #a2a9b1; }
.references { font-size: 0.875rem; margin-top: 2em; border-top: 1px solid #a2a9b1; padding-top: 1em; }
.references h2 { font-size: 1.2rem; cursor: default; } .references h2 .toggle-icon { display: none; }
@media (max-width: 768px) { .content-box { float: none; width: 100%; margin: 1em 0; } .main-content { padding: 1em; } .container { padding: 0.5em; } }
</style></head><body>
<header class="header"><div class="logo-container" id="wiki-logo"><div class="logo"><img src="images/logo.png" alt="Логотип"></div><div class="logo-text">Орден Вики <span>Энциклопедия Ананаса</span></div></div></header>
<div class="container"><main class="main-content"><header class="article-header"><h1>${title}</h1></header>
${contentHtml}
<div class="references"><h2>См. также</h2><ul>${seeAlsoHtml}</ul></div></main></div>
<script>
function checkFileExists(url,cb){const xhr=new XMLHttpRequest();xhr.open('HEAD',url,true);xhr.onreadystatechange=function(){if(xhr.readyState===4)cb(xhr.status===0||xhr.status===200);};try{xhr.send();}catch(e){cb(false);}}
document.addEventListener('DOMContentLoaded',function(){
document.getElementById('wiki-logo').addEventListener('click',function(){window.location.href='index.html';});
const h2s=document.querySelectorAll('h2');h2s.forEach(h2=>{if(!h2.closest('.references')&&!h2.closest('.content-box')){if(!h2.querySelector('.toggle-icon')){h2.innerHTML+=' <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>';}let next=h2.nextElementSibling;const contentDiv=document.createElement('div');contentDiv.className='collapsible-content';h2.parentNode.insertBefore(contentDiv,next);while(next&&next.tagName!=='H2'&&!next.classList.contains('references')){let current=next;next=next.nextElementSibling;contentDiv.appendChild(current);}}});
const checkLinks=document.querySelectorAll('a[href]');checkLinks.forEach(link=>{const href=link.getAttribute('href');if(!href.startsWith('http')&&!href.startsWith('#')&&!href.startsWith('mailto:')){link.addEventListener('click',function(e){e.preventDefault();const targetFile=this.getAttribute('href');checkFileExists(targetFile,function(exists){window.location.href=exists?targetFile:'develop.html';});});}});
const sectionHeaders=document.querySelectorAll('h2');sectionHeaders.forEach(header=>{if(!header.closest('.references')&&!header.closest('.content-box')){header.addEventListener('click',function(){const content=this.nextElementSibling;if(content&&content.classList.contains('collapsible-content')){const isCollapsed=content.classList.contains('collapsed');const icon=this.querySelector('.toggle-icon i');if(isCollapsed){content.classList.remove('collapsed');if(icon)icon.className='fas fa-chevron-down';}else{content.classList.add('collapsed');if(icon)icon.className='fas fa-chevron-right';}}});}});});
<\/script></body></html>`;

            window.onbeforeunload = null;
            const blob = new Blob([fullHTML], {type: "text/html"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename + ".html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => { window.onbeforeunload = function() { return "Данные не сохранены."; }; }, 1000);
        }
    </script>
</body>
</html>
